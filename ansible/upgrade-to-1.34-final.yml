---
# Final upgrades: 1.32 -> 1.33 -> 1.34
- name: Upgrade cluster to 1.33
  hosts: all
  become: yes

  tasks:
    # Master upgrade to 1.33
    - name: Upgrade master to 1.33
      block:
        - name: Unhold packages
          dpkg_selections:
            name: "{{ item }}"
            selection: install
          loop: [kubelet, kubeadm, kubectl]

        - name: Setup 1.33 repository
          shell: |
            rm -f /etc/apt/sources.list.d/kubernetes.list /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list
            apt-get update
            apt-get install -y kubeadm=1.33.*

        - name: Upgrade master control plane
          command: kubeadm upgrade apply v1.33.0 -y

        - name: Upgrade kubelet and kubectl
          apt:
            name:
              - "kubelet=1.33.*"
              - "kubectl=1.33.*"
            state: present

        - name: Restart kubelet
          systemd:
            name: kubelet
            state: restarted
            daemon_reload: yes

        - name: Hold packages
          dpkg_selections:
            name: "{{ item }}"
            selection: hold
          loop: [kubelet, kubeadm, kubectl]

        - name: Wait for master to be Ready
          command: kubectl get nodes
          register: nodes_check
          until: '"NotReady" not in nodes_check.stdout'
          retries: 10
          delay: 10

      when: inventory_hostname in groups['master']

    # Workers upgrade to 1.33
    - name: Upgrade workers to 1.33
      block:
        - name: Drain node
          command: "kubectl drain {{ hostvars[inventory_hostname]['private_dns'] }} --ignore-daemonsets --delete-emptydir-data --disable-eviction"
          delegate_to: "{{ groups['master'][0] }}"

        - name: Unhold packages
          dpkg_selections:
            name: "{{ item }}"
            selection: install
          loop: [kubelet, kubeadm, kubectl]

        - name: Setup 1.33 repository
          shell: |
            rm -f /etc/apt/sources.list.d/kubernetes.list /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list
            apt-get update
            apt-get install -y kubeadm=1.33.* kubelet=1.33.* kubectl=1.33.*
            kubeadm upgrade node
            systemctl restart kubelet
            apt-mark hold kubelet kubeadm kubectl

        - name: Uncordon node
          command: "kubectl uncordon {{ hostvars[inventory_hostname]['private_dns'] }}"
          delegate_to: "{{ groups['master'][0] }}"

      when: inventory_hostname in groups['workers']

    - name: Verify all nodes on 1.33
      command: kubectl get nodes
      register: nodes_133
      when: inventory_hostname in groups['master']
      run_once: true

    - debug:
        msg: "{{ nodes_133.stdout_lines }}"
      when: inventory_hostname in groups['master']
      run_once: true

    - pause:
        seconds: 30
      run_once: true

- name: Upgrade cluster to 1.34
  hosts: all
  become: yes

  tasks:
    # Master upgrade to 1.34
    - name: Upgrade master to 1.34
      block:
        - name: Unhold packages
          dpkg_selections:
            name: "{{ item }}"
            selection: install
          loop: [kubelet, kubeadm, kubectl]

        - name: Setup 1.34 repository
          shell: |
            rm -f /etc/apt/sources.list.d/kubernetes.list /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list
            apt-get update
            apt-get install -y kubeadm=1.34.*

        - name: Upgrade master control plane
          command: kubeadm upgrade apply v1.34.0 -y

        - name: Upgrade kubelet and kubectl
          apt:
            name:
              - "kubelet=1.34.*"
              - "kubectl=1.34.*"
            state: present

        - name: Restart kubelet
          systemd:
            name: kubelet
            state: restarted
            daemon_reload: yes

        - name: Hold packages
          dpkg_selections:
            name: "{{ item }}"
            selection: hold
          loop: [kubelet, kubeadm, kubectl]

        - name: Wait for master to be Ready
          command: kubectl get nodes
          register: nodes_check_134
          until: '"NotReady" not in nodes_check_134.stdout'
          retries: 10
          delay: 10

      when: inventory_hostname in groups['master']

    # Workers upgrade to 1.34
    - name: Upgrade workers to 1.34
      block:
        - name: Drain node
          command: "kubectl drain {{ hostvars[inventory_hostname]['private_dns'] }} --ignore-daemonsets --delete-emptydir-data --disable-eviction"
          delegate_to: "{{ groups['master'][0] }}"

        - name: Unhold packages
          dpkg_selections:
            name: "{{ item }}"
            selection: install
          loop: [kubelet, kubeadm, kubectl]

        - name: Setup 1.34 repository
          shell: |
            rm -f /etc/apt/sources.list.d/kubernetes.list /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list
            apt-get update
            apt-get install -y kubeadm=1.34.* kubelet=1.34.* kubectl=1.34.*
            kubeadm upgrade node
            systemctl restart kubelet
            apt-mark hold kubelet kubeadm kubectl

        - name: Uncordon node
          command: "kubectl uncordon {{ hostvars[inventory_hostname]['private_dns'] }}"
          delegate_to: "{{ groups['master'][0] }}"

      when: inventory_hostname in groups['workers']

- name: Final verification
  hosts: master
  become: yes
  tasks:
    - name: Get final cluster status
      command: kubectl get nodes -o wide
      register: final_nodes

    - debug:
        msg: |
          ========================================
          Kubernetes Upgrade Complete!
          ========================================
          {{ final_nodes.stdout_lines | join('\n') }}
          ========================================

    - name: Get Kubernetes version
      command: kubectl version --short
      register: k8s_version

    - debug:
        msg: "{{ k8s_version.stdout_lines }}"

    - name: Check pods
      command: kubectl get pods --all-namespaces
      register: all_pods

    - debug:
        msg: "{{ all_pods.stdout_lines }}"
